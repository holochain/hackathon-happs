<instagram-clone></instagram-clone>

<script type="module">
  import module from "./deps/module.js";

  const $ = module("instagram-clone", {
    dogs: [],
    filtered: false,
    loading: true
  });

  (function initialize() {
    fetch("https://retoolapi.dev/lfaPzW/dogs")
      .then((res) => res.json())
      .then((dogs) => $.teach({
        dogs,
        loading: false
      }));
  })()

  $.draw((target) => {
    const {
      dogs,
      loading,
      filtered
    } = $.learn();

    if (loading) return "Loading";

    return `
      <input
        type="checkbox"
        class="like-filter"
        id="like-filter"
        ${filtered ? 'checked="true"' : ''}"
      />
      <label for="like-filter">Liked Dogs Only</label>
      <div class="dog-list">${
        dogs
          .filter(maybeByLiked)
          .map(renderDog)
          .join("")
      }</div>
      <div class="zero-state">
        Sorry, no dogs
      </div>
    `;
  });

  function maybeByLiked(dog) {
    const {
      filtered
    } = $.learn();
    return filtered ? dog.liked : true;
  }

  function renderDog(dog) {
    const {
      liked,
      id
    } = dog;
    const button = liked ?
      `
        <button class="like like--is-liked" data-id="${id}">
          Unlike
        </button>
      ` :
      `
        <button class="like" data-id="${id}">
          Like
        </button>
      `;

    return `
      <div class="post">
        <img src="${dog.url}" alt="photo of a dog" />
          ${button}
      </div>
    `;
  }

  $.when("change", ".like-filter", function changeLikeFilter(event) {
    const {
      filtered
    } = $.learn();
    $.teach({
      filtered: !filtered
    });
  });

  $.when("click", ".like", function changeLikeStatus(event) {
    const { id } = event.target.dataset;
    const { dogs } = $.learn();
    const dog = dogs.find(
      (x) => x.id === parseInt(id, 10)
    );

    $.teach({
      ...dog,
      liked: !dog.liked
    }, changeDog);
  });

  function changeDog(state, changedDog) {
    const newDogList = state.dogs.map((dog) => {
      if (dog.id === parseInt(changedDog.id)) {
        return changedDog;
      }
      return dog;
    });

    return {
      ...state,
      dogs: newDogList
    };
  }

  $.flair(`
    & {
      display: block;
      margin: 0 auto;
      max-width: 320px;
      background: #f5f5f5;
      --space-0: 0;
      --space-1: 1px;
      --space-2: 2px;
      --space-3: 4px;
      --space-4: 8px;
      --space-5: 12px;
      --space-6: 16px;
      --space-7: 24px;
      --space-8: 32px;
      --space-9: 52px;
      font-family: sans-serif;
      line-height: 1.5rem;
      color: #555;
    }

    .zero-state {
      display: none;
    }

    & .dog-list {
      display: grid;
      gap: var(--space-4);
    } 

    & .dog-list:empty + .zero-state {
      display: block;
    }

    & .post {
      position: relative;
    }

    & .post::after {
      content: "";
      display: block;
      padding-bottom: 100%;
    }

    & img {
      position: absolute;
      object-fit: cover;
      width: 100%;
      height: 100%;
      max-width: 100%;
    }

    & .like {
      cursor: pointer;
      position: absolute;
      bottom: 0;
      right: 0;
      border: 0;
      background: transparent;
      color: white;
      font-size: 3rem;
      font-weight: 800;
      padding: var(--space-4);
    }

    & .like--is-liked {
      color: pink;
    }
  `);
</script>
